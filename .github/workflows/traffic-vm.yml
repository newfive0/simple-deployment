name: Deploy Traffic VM from Scratch

on:
  workflow_dispatch:
    inputs:
      vm_name:
        description: 'Name for the Traffic VM'
        required: true
        default: 'traffic-vm'
      machine_type:
        description: 'Machine type for the VM'
        required: true
        default: 'e2-micro'
      subnet:
        description: 'Subnet to use'
        required: true
        default: 'outbound-egress-subnet-1'
      simple_traffic_ref:
        description: 'Branch or tag from simple-traffic to deploy'
        required: false
        default: 'main'
        type: string

env:
  PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  SERVICE: simple-traffic
  REGION: us-central1
  ZONE: us-central1-a

jobs:
  build-and-deploy-container:
    runs-on: ubuntu-latest
    outputs:
      simple_traffic_sha: ${{ steps.get-sha.outputs.sha }}

    steps:
    - name: Checkout simple-traffic repository
      uses: actions/checkout@v4
      with:
        repository: wuyq0808/simple-traffic
        ref: ${{ inputs.simple_traffic_ref }}
        token: ${{ secrets.REPO_ACCESS_TOKEN }}

    - name: Get simple-traffic commit SHA
      id: get-sha
      run: echo "sha=$(git rev-parse HEAD)" >> $GITHUB_OUTPUT

    - name: Google Auth
      id: auth
      uses: 'google-github-actions/auth@v2'
      with:
        credentials_json: '${{ secrets.GCP_SA_KEY }}'

    - name: Configure Docker for Artifact Registry
      run: gcloud auth configure-docker ${{ env.REGION }}-docker.pkg.dev

    - name: Build and Push to Artifact Registry
      run: |-
        docker build -t ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.SERVICE }}/${{ env.SERVICE }}:${{ steps.get-sha.outputs.sha }} ./
        docker push ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.SERVICE }}/${{ env.SERVICE }}:${{ steps.get-sha.outputs.sha }}


  deploy-traffic-vm:
    runs-on: ubuntu-latest
    needs: build-and-deploy-container

    steps:
    - name: Checkout simple-traffic repository
      uses: actions/checkout@v4
      with:
        repository: wuyq0808/simple-traffic
        ref: ${{ inputs.simple_traffic_ref }}
        token: ${{ secrets.REPO_ACCESS_TOKEN }}

    - name: Google Auth
      id: auth
      uses: 'google-github-actions/auth@v2'
      with:
        credentials_json: '${{ secrets.GCP_SA_KEY }}'

    - name: Delete and Create Traffic VM
      run: |
        bash ./github_action_scripts/delete-and-create-vm.sh \
          "${{ github.event.inputs.vm_name }}" \
          "${{ github.event.inputs.machine_type }}" \
          "${{ github.event.inputs.subnet }}" \
          "${{ env.ZONE }}"

    - name: Install Dependencies on VM
      run: |
        bash ./github_action_scripts/install-dependencies.sh \
          "${{ github.event.inputs.vm_name }}" \
          "${{ env.ZONE }}"

    - name: Create Clean Dependencies Snapshot
      run: |
        bash ./github_action_scripts/create-snapshot.sh \
          "${{ github.event.inputs.vm_name }}" \
          "${{ env.ZONE }}"

    - name: Deploy Container to Traffic VM
      run: |-
        VM_NAME="${{ github.event.inputs.vm_name }}"

        # Create service account key file locally
        echo '${{ secrets.GCP_SA_KEY }}' > /tmp/sa-key.json

        # Copy service account key to VM
        gcloud compute scp /tmp/sa-key.json $VM_NAME:/tmp/service-account-key.json --zone=${{ env.ZONE }}

        # Deploy container using script
        bash ./github_action_scripts/deploy-container.sh \
          "$VM_NAME" \
          "${{ env.ZONE }}" \
          "${{ env.REGION }}" \
          "${{ env.PROJECT_ID }}" \
          "${{ env.SERVICE }}" \
          "${{ needs.build-and-deploy-container.outputs.simple_traffic_sha }}"

        # Clean up local key file
        rm -f /tmp/sa-key.json

    - name: Setup Traffic Scripts and Rules
      run: |
        VM_NAME="${{ github.event.inputs.vm_name }}"

        # Copy all traffic files to VM
        gcloud compute scp --zone=${{ env.ZONE }} --recurse ./vm-scripts/ $VM_NAME:/tmp/

        # Setup traffic scripts
        bash ./github_action_scripts/setup-traffic-scripts.sh \
          "$VM_NAME" \
          "${{ env.ZONE }}" \
          "/tmp/vm-scripts"

    - name: Start Traffic Proxy
      run: |
        bash ./github_action_scripts/start-traffic-proxy.sh \
          "${{ github.event.inputs.vm_name }}" \
          "${{ env.ZONE }}" \
          "${{ env.PROJECT_ID }}"

    - name: Create firewall rules
      run: bash ./github_action_scripts/create-firewall-rules.sh
